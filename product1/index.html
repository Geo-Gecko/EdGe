 <!DOCTYPE html>
 <html>

 <head>
   <meta charset="utf-8" />
   <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
   <meta name="description" content="Save the Children Product1." />

   <title>Save the children Product1</title>

   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3/dist/leaflet.css" />
   <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />
   <link rel="stylesheet" href="css/normalize.css" />
   <link rel="stylesheet" href="css/skeleton.css" />

   <style>
     body {
       margin: 0;
       padding: 0;
     }

     #map {
       position: absolute;
       top: 0;
       bottom: 0;
       right: 0;
       left: 0;
     }

     .control-panel {
       position: absolute;
       bottom: 0;
       right: 0;
       opacity: 0.85;
       margin-right: 10px;
       margin-bottom: 25px;
       z-index: 1000;
       /* max-width: 50%; */
       max-width: 400px;
       /* max-height: 515px; */
       max-height: 90%;
       overflow-y: auto;
       border-top: 3px solid #33C3F0;
       border-bottom: 3px solid #33C3F0;
       background-color: #f8f8f8;
     }

     .control-panel h4 {
       text-align: center;
       margin-bottom: 1rem;
     }

     .control-panel p {
       margin-bottom: .5rem;
     }

     .control-panel input[type=number] {
       width: 48%;
     }

     .control-panel label {
       font-weight: inherit;
       margin-bottom: 1rem;
     }

     .control-panel select {
       margin-bottom: 1rem;
     }

     @media (max-width: 550px),
     (max-height: 550px) {
       .control-panel {
         max-height: 200px;
         margin-right: 0;
         margin-bottom: 16px;
       }

       .control-panel h4 {
         font-size: 2.4rem !important;
       }
     }

     @media (max-width: 550px) {
       .control-panel {
         max-width: 100%;
         width: 100%;
       }
     }

     .selected {
       background-color: #c3fd3d !important;
     }

     .containerIMG {
       display: flex;
       flex-direction: row;
       flex-wrap: nowrap;
       align-items: center !important;
     }

     img {
       flex: 1;
       max-width: 100%;
       height: auto;
       max-height: 310px;
     }
   </style>

 </head>

 <body>

   <div id="map"></div>
   <div id="controlPanel" class="control-panel">

     <div class="container" style="width: 100%; padding: 5px 10px; text-align: left;">

       <h5 style="text-align: left;">Primary School Referral Map</h5>

       <div class="btn-group">
         <button type="button" id="reset" class="btn btn-secondary">Reset map</button>
       </div>
       <hr>

       <div id="legend"></div>
       <hr>
       <p>
         <strong>Highlight by responsible agency</strong>
       </p>
       <div class="row">
         <div id='dropDownContainer' class="six columns">
         </div>
       </div>

       <hr>

       <p id="infoText">
         Click on a point to show additional information below.
       </p>

       <div id="sidebar-content"></div>

       <hr>


       <a href="https://www.geogecko.com/"><img style="z-index: 10000; position: fixed; bottom: 2%; left: 0; border: 0; width: 4em;" src="css/images/Logo_pin.svg" alt="GeoGecko">></a>

       <div class="containerIMG" style="width: 930px; max-width: 100%;">
         <a style="max-width:30%; padding-right: 2rem;" href=""><img src="css/images/ECW-full-logo-and-tagline-orange-and-whitetagline-RGB.png" alt="ECW"></a>
         <a style="max-width:30%;float:right !important;" href=""><img src="css/images/ECO.png" alt="ECO"></a>
         <!-- <a style="max-width:30%; padding-right: 2rem; " href="https://www.geogecko.com/"><img src="css/images/Logo_pin.svg" alt="GeoGecko"></a> -->
       </div>

       <div style="width: 100%;">
       </div>


     </div>


     <!-- first load LeafletJS -->
     <script src="https://unpkg.com/leaflet@1.3/dist/leaflet.js"></script>

     <!-- load Esri Leaflet because we want to use an Esri basemap -->
     <!-- <script src="https://unpkg.com/esri-leaflet@2.1/dist/esri-leaflet.js"></script> -->

     <!-- load animation tweening lib requirement for CanvasFlowMapLayer -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"></script>

     <!-- then load CanvasFlowMapLayer -->
     <script src="https://jwasilgeo.github.io/Leaflet.Canvas-Flowmap-Layer/src/CanvasFlowmapLayer.js"></script>

     <!-- also load 3rd-party CSV parsing libary just for this demo  -->
     <script src="https://unpkg.com/papaparse@4.3/papaparse.min.js"></script>

     <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

     <script src="https://d3js.org/d3.v5.min.js"></script>
     <script src="./src/piechartAndLegend.js"></script>


     <script>
       var map = L.map('map', {
         zoomSnap: 0.25
       });
       var geoJsonFeatureCollection;
       if (L.Browser.mobile) {
         map.setView([1.291471, 32.482235], 7);
       } else {
         map.setView([1.291471, 34.482235], 7);
       }

       var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
         maxZoom: 19,
         attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
       }).addTo(map);

       //  L.esri.basemapLayer('DarkGray').addTo(map);

       Papa.parse('./docs/csv-data/data.csv', {
         download: true,
         header: true,
         dynamicTyping: true,
         skipEmptyLines: true,
         complete: function(results) {

           // console.log(results)
           var filterList = d3.nest().key(function(d) {
             return d.Organisation_Name;
           }).sortKeys(d3.ascending).entries(results.data);

           geoJsonFeatureCollection = {
             type: 'FeatureCollection',
             features: results.data.map(function(datum) {
               return {
                 type: 'Feature',
                 geometry: {
                   type: 'Point',
                   coordinates: [datum.s_lon, datum.s_lat]
                 },
                 properties: {

                   "origin_city": datum,
                   "Organisation_Name": datum.Organisation_Name,
                   "s_city_id": datum.s_city_id,
                   "School": datum.School,
                   "e_city_id": datum.e_city_id,
                   "Referral_Pathway": datum.Referral_Pathway,
                   "Transition_Pathway": datum.Transition_Pathway,
                   "s_lat": datum.s_lat,
                   "s_lon": datum.s_lon,
                   "e_lat": datum.e_lat,
                   "e_lon": datum.e_lon
                 }
               }
             })
           };

           var oneToManyFlowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
               originAndDestinationFieldIds: {
                 originUniqueIdField: 's_city_id',
                 originGeometry: {
                   x: 's_lon',
                   y: 's_lat'
                 },
                 destinationUniqueIdField: 'e_city_id',
                 destinationGeometry: {
                   x: 'e_lon',
                   y: 'e_lat'
                 }
               },
               pathDisplayMode: 'selection',
               animationStarted: true,
               animationEasingFamily: 'Cubic',
               animationEasingType: 'In',
               animationDuration: 2000
             }).addTo(map)
             .on('click', function(point) {
               //  $('#sidebar-content').text("The data is: " + point.propagatedFrom.feature.properties.School)
             });

           function resetMap() {

             var array = ['#FFB400', '#f88379', "#76a646", "#AAB931"];
             var arrayLabel = ["Primary School Only", "Accelerated Education Programme Centre", "Referral Pathways", "Transition Pathways"];

             addLegend(array, arrayLabel, "Legend", "circle");
             for (key in map['_layers']) {
               if (typeof map['_layers'][key]['feature'] !== 'undefined') {
                 var l = map['_layers'][key];
                 if (l['feature']['properties']['isOrigin'] && l['feature']['properties']['origin_city']['Is_the_Support_for_Primary_School_or_AEP_centre_hosted_by_the_school?'] === 'Primary School') {
                   l.setStyle({
                     radius: 6,
                     fillColor: "#FFB400",
                     color: "#000",
                     weight: 1,
                     opacity: 1,
                     fillOpacity: 0.8
                   })
                 } else if (l['feature']['properties']['isOrigin'] && l['feature']['properties']['origin_city']['Is_the_Support_for_Primary_School_or_AEP_centre_hosted_by_the_school?'] === 'AEP centre') {
                   l.setStyle({
                     radius: 6,
                     fillColor: "#f88379",
                     color: "#000",
                     weight: 1,
                     opacity: 1,
                     fillOpacity: 0.8
                   })
                 } else if (!l['feature']['properties']['isOrigin'] && l['feature']['properties']['origin_city']['Pathway'] === 'Referral') {
                   l.setStyle({
                     radius: 6,
                     fillColor: "#76a646",
                     color: "#000",
                     weight: 1,
                     opacity: 1,
                     fillOpacity: 0.8
                   })
                 } else if (!l['feature']['properties']['isOrigin'] && l['feature']['properties']['origin_city']['Pathway'] === 'Transition') {
                   l.setStyle({
                     radius: 6,
                     fillColor: "#AAB931",
                     color: "#000",
                     weight: 1,
                     opacity: 1,
                     fillOpacity: 0.8
                   })
                 }
               }
             }

           }

           resetMap();

           // Updates the displayed map markers to reflect the crossfilter dimension passed in
           var updateMap = function(locs) {
             // clear the existing markers from the map
             //markersLayer.clearLayers();
             //clusterLayer.clearLayers();

             var minlat = 200,
               minlon = 200,
               maxlat = -200,
               maxlon = -200;

             locs.forEach(function(d, i) {

               if (d.latitude != null && d.latitude != undefined) {
                 // add a Leaflet marker for the lat lng and insert the application's stated purpose in popup\
                 //var mark = L.marker([d.latitude, d.longitude]);
                 //markersLayer.addLayer(mark);
                 //clusterLayer.addLayer(mark);

                 // find corners
                 if (minlat > d.latitude) minlat = d.latitude;
                 if (minlon > d.longitude) minlon = d.longitude;
                 if (maxlat < d.latitude) maxlat = d.latitude;
                 if (maxlon < d.longitude) maxlon = d.longitude;
               }
             });

             c1 = L.latLng(minlat, minlon);
             c2 = L.latLng(maxlat, maxlon + 2);
             c3 = L.latLng(maxlat, maxlon);

             // fit bounds
             if (L.Browser.mobile) {
               map.fitBounds(L.latLngBounds(c1, c3));
             } else {
               map.fitBounds(L.latLngBounds(c1, c2));
             }

             // correct zoom to fit markers
             setTimeout(function() {
               map.setZoom(map.getZoom() - 0.25);
             }, 500);

           };

           // since this demo is using the optional "pathDisplayMode" as "selection",
           // it is up to the developer to wire up a click or mouseover listener
           // and then call the "selectFeaturesForPathDisplay()" method to inform the layer
           // which Bezier paths need to be drawn
           oneToManyFlowmapLayer.on('click', function(e) {
             resetMap();

             SelectElement("options", "None");
             $('#infoText').html('Information about selected point below.');
             //  console.log(e)
             if (e.sharedOriginFeatures.length) {
               $('#sidebar-content').html(

                 "<table>" +
                 "<tr><td>Type of facility</td><td>" + e.layer.feature.properties.origin_city["Is_the_Support_for_Primary_School_or_AEP_centre_hosted_by_the_school?"] + "</td><tr>" +
                 "<tr><td>Name of facility</td><td>" + e.layer.feature.properties.origin_city.School + "</td><tr>" +
                 "<tr><td>Name of Referral Facility</td><td>" + e.sharedOriginFeatures[1].properties.origin_city["Name_of_pathway"] + "</td><tr>" +
                 "<tr><td>Name of Transition Facility</td><td>" + e.sharedOriginFeatures[0].properties.origin_city["Name_of_pathway"] + "</td><tr>" +
                 "<tr><td>Total Students</td><td>" + e.layer.feature.properties.origin_city["Total Students"] + "</td><tr>" +
                 "<tr><td>Refugee Students</td><td>" + e.layer.feature.properties.origin_city["Refugee Students"] + "</td><tr>" +
                 "<tr><td>Total Teachers</td><td>" + e.layer.feature.properties.origin_city["Total Teachers"] + "</td><tr>" +
                 "<tr><td>Refugee Teachers</td><td>" + e.layer.feature.properties.origin_city["Refugee Teachers"] + "</td><tr>" +
                 "<tr><td>Organisation</td><td>" + e.layer.feature.properties.origin_city["Organisation_Name"] + "</td><tr>" +
                 "<tr><td>Date of Data Collection</td><td>" + e.layer.feature.properties.origin_city["Date of Data Collection"] + "</table>")

               oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
               var locations = [];
               e.sharedOriginFeatures.forEach(function(d, i) {
                 locations.push({
                   latitude: d.properties.e_lat,
                   longitude: d.properties.e_lon
                 });
                 locations.push({
                   latitude: d.properties.s_lat,
                   longitude: d.properties.s_lon
                 });
               })
               updateMap(locations);
             }
             if (e.sharedDestinationFeatures.length) {
               var totalStudents = 0,
                 totalRefugeeStudents = 0,
                 totalTeachers = 0,
                 totalRefugeeTeachers = 0;
               e.sharedDestinationFeatures.forEach(function(d, i) {
                 totalStudents = totalStudents + d.properties.origin_city["Total Students"];
                 totalRefugeeStudents = totalRefugeeStudents + d.properties.origin_city["Refugee Students"];
                 totalTeachers = totalTeachers + d.properties.origin_city["Total Teachers"];
                 totalRefugeeTeachers = totalRefugeeTeachers + d.properties.origin_city["Refugee Teachers"];
               })

               $('#sidebar-content').html(
                 "<table>" +
                 //  "Type of facility: " + e.layer.feature.properties.origin_city["Is_the_Support_for_Primary_School_or_AEP_centre_hosted_by_the_school?"] + "<br>" +
                 "<tr><td>Name of facility</td><td>" + e.layer.feature.properties.origin_city.Name_of_pathway + "</td><tr>" +
                 "<tr><td>Total Students</td><td>" + totalStudents + "</td><tr>" +
                 "<tr><td>Refugee Students</td><td>" + totalRefugeeStudents + "</td><tr>" +
                 "<tr><td>Total Teachers</td><td>" + totalTeachers + "</td><tr>" +
                 "<tr><td>Refugee Teachers</td><td>" + totalRefugeeTeachers + "</td><tr>" +
                 "<tr><td>Date of Data Collection</td><td>" + e.layer.feature.properties.origin_city["Date of Data Collection"] + "</table>")

               oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
               var locations = [];
               e.sharedDestinationFeatures.forEach(function(d, i) {
                 locations.push({
                   latitude: d.properties.e_lat,
                   longitude: d.properties.e_lon
                 });
                 locations.push({
                   latitude: d.properties.s_lat,
                   longitude: d.properties.s_lon
                 });
               })
               updateMap(locations);
             }
           });

           //  var inputdata = 123 || 456 || 789;
           //  var split = input.split('||');
           var select = $('<select name="options" id="options" style="max-width: 300px;"><option value="None">- None -</option></select>');
           $.each(filterList, function(index, value) {
             var option = $('<option></option>');
             option.attr('value', value.key);
             option.text(value.key);
             select.append(option);
           });
           $('#dropDownContainer').empty().append(select);

           $('#options').change(function() {
             reset();
             $('#infoText').html('Click on a point to show additional information below.');
             var array = ["#f7f7f6", '#c3ff3e', '#7d7d7d'];
             var arrayLabel = ["", "Selected agency facilities", "Other agency facilities"];

             addLegend(array, arrayLabel, "Legend", "circle");
             if ($(this).val() === "None") {
               resetMap();
             } else {
               for (key in map['_layers']) {
                 if (typeof map['_layers'][key]['feature'] !== 'undefined') {
                   var l = map['_layers'][key];
                   if (l['feature']['properties']['origin_city']['Organisation_Name'] === $(this).val()) {
                     l.setStyle({
                       radius: 6,
                       fillColor: "#c3ff3e",
                       color: "#000",
                       weight: 1,
                       opacity: 1,
                       fillOpacity: 0.8
                     })
                   } else {
                     l.setStyle({
                       radius: 6,
                       fillColor: "#7d7d7d",
                       color: "#000",
                       weight: 1,
                       opacity: 0.4,
                       fillOpacity: 0.4
                     })
                   }
                 }
               }
             }

           });

           function SelectElement(id, valueToSelect) {
             var element = document.getElementById(id);
             element.value = valueToSelect;
           }

           function reset() {
             resetMap();
             oneToManyFlowmapLayer.clearAllPathSelections();

             $('#sidebar-content').html("");

             if (L.Browser.mobile) {
               map.setView([1.291471, 32.482235], 7);
             } else {
               map.setView([1.291471, 34.482235], 7);
             }
           }

           $('#reset').on('click', function() {
             reset();

             $('#infoText').html('Click on a point to show additional information below.');

             SelectElement("options", "None");
           })

           // immediately select an origin point for Bezier path display,
           // instead of waiting for the first user click event to fire
           var min = 0;
           var max = 121;
           var random = Math.floor(Math.random() * (+max - +min)) + +min;
           //  oneToManyFlowmapLayer.selectFeaturesForPathDisplayById('s_city_id', 15, true, 'SELECTION_NEW');
         }
       });
     </script>

 </body>

 </html>