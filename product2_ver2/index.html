 <!DOCTYPE html>
 <html>

 <head>
   <meta charset="utf-8" />
   <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
   <meta name="description" content="Canvas Flowmap Layer with LeafletJS." />

   <title>Save the children Product2</title>

   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3/dist/leaflet.css" />
   <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />
   <link rel="stylesheet" href="css/normalize.css" />
   <link rel="stylesheet" href="css/skeleton.css" />
   <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.js"></script>
   <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.css" /> -->
   <link rel="stylesheet" href="css/nouislider.css" />
   <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
   <!-- Color Scale -->
   <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

   <style>
     body {
       margin: 0;
       padding: 0;
     }

     #map {
       position: absolute;
       top: 0;
       bottom: 0;
       right: 0;
       left: 0;
     }

     .control-panel {
       position: absolute;
       bottom: 0;
       right: 0;
       opacity: 0.85;
       margin-right: 10px;
       margin-bottom: 25px;
       z-index: 1000;
       /*max-width: 50%; */
       width: 500px;
       /* max-height: 515px; */
       height: 93%;
       overflow-y: auto;
       border-top: 3px solid #33C3F0;
       border-bottom: 3px solid #33C3F0;
       background-color: #f8f8f8;
     }

     .control-panel h4 {
       text-align: center;
       margin-bottom: 1rem;
     }

     .control-panel p {
       margin-bottom: .5rem;
     }

     .control-panel input[type=number] {
       width: 48%;
     }

     .control-panel label {
       font-weight: inherit;
       margin-bottom: 1rem;
     }

     .control-panel select {
       margin-bottom: 1rem;
     }

     @media (max-width: 550px),
     (max-height: 550px) {
       .control-panel {
         max-height: 40%;
         margin-right: 0;
         margin-bottom: 16px;
       }

       .control-panel h4 {
         font-size: 2.4rem !important;
       }
     }

     @media (max-width: 550px) {
       .control-panel {
         max-width: 100%;
         width: 100%;
       }
     }

     .sliders {
       margin: auto;
       width: 85%;
     }

     .containerIMG {
       display: flex;
       flex-direction: row;
       flex-wrap: nowrap;
       align-items: center !important;
     }

     img {
       flex: 1;
       max-width: 100%;
       height: auto;
       max-height: 310px;
     }
   </style>

 </head>

 <body>

   <div id="map"></div>
   <div id="controlPanel" class="control-panel">


     <div class="w3-bar w3-black" style="width: 80% !important; margin: auto !important;">
       <left>
         <br>
         <button class="w3-bar-item w3-button" onclick="openPanel('Filters')">Filters</button>
         <button class="w3-bar-item w3-button" onclick="openPanel('Statistics')">School statistics</button>
       </left>
     </div>

     <a href="https://www.geogecko.com/"><img style="z-index: 10000; position: fixed; bottom: 2%; left: 0; border: 0; width: 4em;" src="css/images/Logo_pin.svg" alt="GeoGecko"></a>

     <div class="w3-bar w3-black" style="width: 80% !important; margin: auto !important;">
      <br>
       <left>
         <span class="filter-count-header" style="height:23.2px; font-size: 18px;">
           <span>Filters (% within school)</span>
           <button class="w3-bar-item w3-button" id="resetSliders">Reset Filters</button>
         </span>
       </left>
    </div>

     <!-- filter panel -->
     <div id="Filters" style="width: 80%; height: 75%; overflow-y: auto; margin: auto;" class="filterclass">

       <!-- numbers -->
       <center>
         <!-- <div>
           <span class="filter-count-header" style="height:23.2px; font-size: 12px;">
             <span>Districts</span>
           </span>
           <span class="filter-count-header" style="height:23.2px; font-size: 12px;">
             <span>Schools</span>
           </span>
           <span class="filter-count-header" style="height:23.2px; font-size: 12px;">
             <span>Settlements</span>
           </span>
         </div>
         <div>
           <span class="filter-count-numbers" style="height:23.2px; font-size: 12px;">
             <span id="district-count">0</span>
           </span>
           <span class="filter-count-numbers" style="height:23.2px; font-size: 12px;">
             <span id="district-count">0</span>
           </span>
           <span class="filter-count-numbers" style="height:23.2px; font-size: 12px;">
             <span id="district-count">0</span>
           </span>
         </div> -->
       </center>


       <!--List of filters:  -->
       <div id='selectYear'></div>
       <div id='selectTerm'></div>
       <div id='sliderContainer'></div>

     </div>

     <!-- Statistic panel -->
     <div id="Statistics" class="filterclass" style="width: 80%; margin: auto; display:none">

       <!-- numbers -->
       <left>
         <div id="sidebar-content"></div>
       </left>


       <!--List of filters:  -->
       <br>
       <left>
         <span class="filter-count-header" style="height:23.2px; font-size: 18px;">
           <span>Statistics</span>
         </span>
       </left>
       <p>
         <strong>Select KPI to chart (Click on a point to generate chart)</strong>
       </p>

       <div class="row">
         <div id="kpiDropDownContainer" style="font-size: small;" class="six columns"></div>
         <div id="yearDropDownContainer" class="six columns"></div>
       </div>

       <!-- Create a div where the graph will take place -->
       <div id="my_dataviz"></div>

     </div>

     <div class="containerIMG" style="width: 930px; max-width: 100%;">
      <a style="max-width:30%;margin: auto;" href=""><img src="css/images/ECW-full-logo-and-tagline-orange-and-whitetagline-RGB.png" alt="ECW"></a>
      <a style="max-width:30%;margin: auto;" href=""><img src="css/images/ECO.png" alt="ECO"></a>
      <!-- <a style="max-width:30%; padding-right: 2rem; " href="https://www.geogecko.com/"><img src="css/images/Logo_pin.svg" alt="GeoGecko"></a> -->
    </div>

   </div>

   <script>
     function openPanel(PanelName) {
       var i;
       var x = document.getElementsByClassName("filterclass");
       for (i = 0; i < x.length; i++) {
         x[i].style.display = "none";
       }
       document.getElementById(PanelName).style.display = "block";
     }
   </script>


   <!-- first load LeafletJS -->
   <script src="https://unpkg.com/leaflet@1.3/dist/leaflet.js"></script>

   <!-- load Esri Leaflet because we want to use an Esri basemap -->
   <script src="https://unpkg.com/esri-leaflet@2.1/dist/esri-leaflet.js"></script>

   <!-- load animation tweening lib requirement for CanvasFlowMapLayer -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"></script>

   <!-- then load CanvasFlowMapLayer -->
   <script src="https://jwasilgeo.github.io/Leaflet.Canvas-Flowmap-Layer/src/CanvasFlowmapLayer.js"></script>

   <!-- also load 3rd-party CSV parsing libary just for this demo  -->
   <script src="https://unpkg.com/papaparse@4.3/papaparse.min.js"></script>

   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


   <script>
     var map = L.map('map');
     var geoJsonFeatureCollection;
     if (L.Browser.mobile) {
       map.setView([1.291471, 32.482235], 7);
     } else {
       map.setView([1.291471, 34.482235], 7);
     }

     var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
     }).addTo(map);

     Papa.parse('docs/csv-data/kpi_data.csv', {
       download: true,
       header: true,
       dynamicTyping: true,
       skipEmptyLines: true,
       complete: function(results) {

         Papa.parse('docs/csv-data/kpiList1.csv', {
           download: true,
           header: true,
           dynamicTyping: true,
           skipEmptyLines: true,
           complete: function(results) {
             filters(results);
           }
         });

         //  var select1 = $('<select name="options" id="optionsYear" style="max-width: 300px;"></select>');
         //  var years = d3.nest().key(function(d) {
         //    return d.Year;
         //  }).sortKeys(d3.ascending).entries(results.data);
         //  $.each(years, function(index, value) {
         //    var option = $('<option></option>');
         //    option.attr('value', value.key);
         //    option.text(value.key);
         //    select1.append(option);
         //  });
         //  $('#yearDropDownContainer').empty().append(select1);

         var summary = d3.nest().key(function(d) {
           return d.School;
         }).sortKeys(d3.ascending).entries(results.data);

         var summary1 = results.data.filter(function(k) {
           if (k.Year === 2019 && k.Term === 3) {
             return k; //return d.Actor_Type["UN"];
           }
         });

         //  should switch to this

         geoJsonFeatureCollection = {
           type: 'FeatureCollection',
           features: summary1.map(function(datum) {
             return {
               type: 'Feature',
               geometry: {
                 type: 'Point',
                 coordinates: [datum.s_lon, datum.s_lat]
               },
               properties: {
                 "original_data": datum
               }
             }
           })
         };

         var geojsonMarkerOptions = {
           radius: 6,
           fillColor: "#c3ff3e",
           color: "#000",
           weight: 1,
           opacity: 1,
           fillOpacity: 0.8
         };
         L.geoJson(geoJsonFeatureCollection, {
             pointToLayer: function(feature, latlng) {
               return L.circleMarker(latlng, geojsonMarkerOptions);
             }
           }).addTo(map)
           .on('click', function(d) {

             openPanel("Statistics");

             $('#sidebar-content').html(
               "<table>" +
               "<tr><td>Type of facility</td><td>" + d.layer.feature.properties.original_data["Is_the_Support_for_Primary_School_or_AEP_centre_hosted_by_the_school?"] + "</td><tr>" +
               "<tr><td>Name of facility</td><td>" + d.layer.feature.properties.original_data.School + "</td><tr>" +
               //  "<tr><td>Name of Referral Facility</td><td>" + e.sharedOriginFeatures[1].properties.original_data["Name_of_pathway"] + "</td><tr>" +
               //  "<tr><td>Name of Transition Facility</td><td>" + e.sharedOriginFeatures[0].properties.original_data["Name_of_pathway"] + "</td><tr>" +
               "<tr><td>Current Number of Students</td><td>" + d.layer.feature.properties.original_data["Current Number of Students"] + "</td><tr>" +
               "<tr><td>Average Attendence</td><td>" + d.layer.feature.properties.original_data["Average Attendence"] + "</td><tr>" +
               "<tr><td>Partner Organisation</td><td>" + d.layer.feature.properties.original_data["Partner Organisation"] + "</td><tr>" + "</table>")

             // d3.select("#my_dataviz").remove();
             $('#my_dataviz').empty()

             var chartData = results.data.filter(function(k) {
               if (k.School === d.layer.feature.properties.original_data.School) {
                 return k; //return d.Actor_Type["UN"];
               }
             }).sort(function(x, y) {
               return d3.ascending(x.Term, y.Term);
             });

             // set the dimensions and margins of the graph
             var margin = {
                 top: 10,
                 right: 100,
                 bottom: 30,
                 left: 30
               },
               width = 460 - margin.left - margin.right,
               height = 400 - margin.top - margin.bottom;

             // append the svg object to the body of the page
             var svg = d3.select("#my_dataviz")
               .append("svg")
               .attr("width", width + margin.left + margin.right)
               .attr("height", height + margin.top + margin.bottom)
               .append("g")
               .attr("transform",
                 "translate(" + margin.left + "," + margin.top + ")");

             // A color scale: one color for each group
             var myColor = d3.scaleOrdinal()
               .domain(chartData)
               .range(d3.schemeSet2);

             // Add X axis --> it is a date format
             var x = d3.scaleLinear()
               .domain([0, 4])
               .range([0, width]);
             svg.append("g")
               .attr("id", "xAxis")
               .attr("transform", "translate(0," + height + ")")
               .call(d3.axisBottom(x).ticks(3));

             // Add Y axis
             var y = d3.scaleLinear()
               .domain([0, 100])
               .range([height, 0]);
             svg.append("g")
               .attr("id", "yAxis")
               .call(d3.axisLeft(y));

             var yAxis = d3.select("#yAxis").selectAll("g:nth-child(odd)").remove();

             var xAxis = d3.select("#xAxis").selectAll("g");

             xAxis._groups[0][0].remove();

             xAxis._groups[0][4].remove();

             xAxis.append("text")
               .text("Terms")

             yAxis.append("text")
               .text("%")

             //  yAxis.remove();

             // Initialize line with group a
             var line = svg
               .append('g')
               .append("path")
               .datum(chartData)
               .attr("d", d3.line()
                 .x(function(d) {
                   //  console.log(d);
                   return x(+d.Term)
                 })
                 .y(function(d) {
                   //  console.log(d);
                   return y(+d["Percentage of beneficiaries reporting that humanitarian assistance is delivered in a safe, accessible, accountable and participatory manner."])
                 })
               )
               .attr("stroke", function(d) {
                 return myColor("valueA")
               })
               .style("stroke-width", 4)
               .style("fill", "none")

             // A function that update the chart
             function update(selectedGroup) {

               // Create new data with the selection?
               var dataFilter = chartData.map(function(d) {
                 return {
                   Term: d.Term,
                   value: d[selectedGroup]
                 }
               })

               // Give these new data to update line
               line
                 .datum(dataFilter)
                 .transition()
                 .duration(1000)
                 .attr("d", d3.line()
                   .x(function(d) {
                     return x(+d.Term)
                   })
                   .y(function(d) {
                     return y(+d.value)
                   })
                 )
                 .attr("stroke", function(d) {
                   return myColor(selectedGroup)
                 })
             }

             $('#options').change(function(d) {
               // recover the option that has been chosen
               var selectedOption = d3.select(this).property("value")
               // run the updateChart function with this selected option
               update(selectedOption)
             })

           })

       }

     });
   </script>
   <script src="src/kpi.js"></script>
 </body>

 </html>